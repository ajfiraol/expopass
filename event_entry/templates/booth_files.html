<!DOCTYPE html>
<html>
<head>
  <title>Booth QR Files</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family:Arial;background:#0f172a;color:#fff;padding:24px}
    h1,h2,h3{margin-bottom:8px}
    .meta{font-size:13px;color:#9ca3af;margin-bottom:16px}
    .breadcrumb{margin-bottom:16px;padding:8px;background:#1e293b;border-radius:4px}
    .breadcrumb a{color:#93c5fd;text-decoration:none;margin:0 4px}
    .breadcrumb a:hover{text-decoration:underline}
    .breadcrumb span{color:#64748b}
    .folder-item{cursor:pointer;padding:8px;margin:4px 0;border-radius:4px;background:#1e293b;display:flex;align-items:center;gap:8px;user-select:none}
    .folder-item:hover{background:#334155}
    .folder-item.expanded{background:#334155}
    .folder-icon{font-size:18px;width:24px;text-align:center}
    .folder-content{margin-left:24px;display:none}
    .folder-content.expanded{display:block}
    .staff-item{padding:12px;margin:8px 0;border-radius:6px;background:#020617;border:1px solid #334155;display:flex;align-items:center;gap:16px}
    .staff-info{flex:1}
    .staff-name{font-weight:bold;font-size:16px}
    .staff-details{font-size:13px;color:#9ca3af;margin-top:4px}
    .qr-preview{width:80px;height:80px;border-radius:4px;border:1px solid #334155;object-fit:contain;background:#fff;flex-shrink:0}
    .btn{padding:6px 12px;border-radius:4px;border:none;cursor:pointer;font-size:13px;text-decoration:none;display:inline-block}
    .btn-primary{background:#2563eb;color:#fff}
    .btn-primary:hover{background:#1d4ed8}
    .btn-danger{background:#dc2626;color:#fff}
    .btn-danger:hover{background:#b91c1c}
    a.button{display:inline-block;margin-bottom:16px;padding:6px 10px;border-radius:4px;background:#2563eb;color:#fff;text-decoration:none}
    a.button:hover{background:#1d4ed8}
    .loading{color:#64748b;font-style:italic;padding:16px}
    .empty-state{color:#64748b;padding:16px;text-align:center}
  </style>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
  <h1>Booth QR Files Browser</h1>
  <div class="breadcrumb" id="breadcrumb">
    <a href="/dashboard/">Dashboard</a> <span>/</span> <span id="current-path">Root</span>
  </div>
  <p><a href="/dashboard/" class="button">Back to Dashboard</a></p>

  <div id="content">
    {% if locations %}
      {% for loc in locations %}
        <div class="folder-item" data-type="location" data-code="{{ loc.code }}" data-name="{{ loc.name }}">
          <span class="folder-icon">üìÅ</span>
          <span><strong>{{ loc.name }}</strong> ({{ loc.booths|length }} booths)</span>
        </div>
        <div class="folder-content" data-parent-location="{{ loc.code }}">
          {% for booth in loc.booths %}
            <div class="folder-item" data-type="booth" data-location="{{ loc.code }}" data-booth="{{ booth.name }}">
              <span class="folder-icon">üìÇ</span>
              <span><strong>{{ booth.name }}</strong> ({{ booth.staff_count }} staff)</span>
            </div>
            <div class="folder-content" data-location="{{ loc.code }}" data-booth="{{ booth.name }}">
              <div class="loading">Click to load staff...</div>
            </div>
          {% endfor %}
        </div>
      {% endfor %}
    {% else %}
      <p class="empty-state">No locations/booths found. Add staff through the dashboard first.</p>
    {% endif %}
  </div>

  <script>
    $(document).ready(function(){
      var currentPath = ['Root'];

      function updateBreadcrumb() {
        var html = '<a href="/dashboard/">Dashboard</a> <span>/</span>';
        for (var i = 0; i < currentPath.length; i++) {
          if (i === currentPath.length - 1) {
            html += ' <span>' + currentPath[i] + '</span>';
          } else {
            html += ' <a href="#" data-level="' + i + '">' + currentPath[i] + '</a> <span>/</span>';
          }
        }
        $('#breadcrumb').html(html);
      }

      function navigateToLevel(level) {
        currentPath = currentPath.slice(0, level + 1);
        updateBreadcrumb();
        showContent();
      }

      function showContent() {
        // Hide all folder contents first
        $('.folder-content').removeClass('expanded').hide();
        $('.folder-item').removeClass('expanded');

        if (currentPath.length === 1) {
          // Root: show all locations
          $('.folder-item[data-type="location"]').show();
        } else if (currentPath.length === 2) {
          // Location: show booths for that location
          var locCode = currentPath[1];
          $('.folder-item[data-type="location"]').hide();
          $('.folder-item[data-type="location"][data-code="' + locCode + '"]').show().addClass('expanded');
          $('.folder-content[data-parent-location="' + locCode + '"]').show().addClass('expanded');
          $('.folder-item[data-type="booth"][data-location="' + locCode + '"]').show();
        } else if (currentPath.length === 3) {
          // Booth: show staff
          var locCode = currentPath[1];
          var boothName = currentPath[2];
          $('.folder-item').hide();
          $('.folder-item[data-type="location"][data-code="' + locCode + '"]').show().addClass('expanded');
          $('.folder-content[data-parent-location="' + locCode + '"]').show().addClass('expanded');
          $('.folder-item[data-type="booth"][data-location="' + locCode + '"][data-booth="' + boothName + '"]').show().addClass('expanded');
          $('.folder-content[data-location="' + locCode + '"][data-booth="' + boothName + '"]').show().addClass('expanded');
          loadBoothStaff(locCode, boothName);
        }
      }

      // Breadcrumb navigation
      $(document).on('click', '#breadcrumb a[data-level]', function(e){
        e.preventDefault();
        var level = parseInt($(this).data('level'));
        navigateToLevel(level);
      });

      // Location click: expand/collapse booths
      $(document).on('click', '.folder-item[data-type="location"]', function(e){
        e.stopPropagation();
        var $item = $(this);
        var locCode = $item.data('code');
        var locName = $item.data('name');
        var $content = $item.next('.folder-content[data-parent-location="' + locCode + '"]');
        var isExpanded = $item.hasClass('expanded');

        if (isExpanded) {
          $item.removeClass('expanded');
          $content.removeClass('expanded').hide();
          currentPath = ['Root'];
        } else {
          $item.addClass('expanded');
          $content.addClass('expanded').show();
          currentPath = ['Root', locName];
        }
        updateBreadcrumb();
      });

      // Booth click: load and show staff
      $(document).on('click', '.folder-item[data-type="booth"]', function(e){
        e.stopPropagation();
        var location = $(this).data('location');
        var booth = $(this).data('booth');
        var locName = $('.folder-item[data-type="location"][data-code="' + location + '"]').data('name');
        var $content = $(this).next('.folder-content[data-location="' + location + '"][data-booth="' + booth + '"]');
        var isExpanded = $(this).hasClass('expanded');

        if (isExpanded) {
          $(this).removeClass('expanded');
          $content.removeClass('expanded').hide();
          currentPath = ['Root', locName];
        } else {
          $(this).addClass('expanded');
          $content.addClass('expanded').show();
          currentPath = ['Root', locName, booth];
          loadBoothStaff(location, booth);
        }
        updateBreadcrumb();
      });

      function loadBoothStaff(location, boothId) {
        var $container = $('.folder-content[data-location="' + location + '"][data-booth="' + boothId + '"]');
        
        // Don't reload if already loaded
        if ($container.find('.staff-item').length > 0) {
          return;
        }

        $container.html('<div class="loading">Loading staff...</div>');

        $.get('/api/booth/' + encodeURIComponent(location) + '/' + encodeURIComponent(boothId) + '/staff/', function(data){
          $container.html('');

          // Show staff list (already sorted ascending by name from backend)
          if (data.staff && data.staff.length > 0) {
            data.staff.forEach(function(staff){
              var qrUrl = staff.qr_url || '/static/no-qr.png';
              var staffHtml = '<div class="staff-item" data-staff-id="' + staff.id + '">' +
                '<img src="' + qrUrl + '" class="qr-preview" alt="QR Code" onerror="this.src=\'/static/no-qr.png\'">' +
                '<div class="staff-info">' +
                '<div class="staff-name">' + escapeHtml(staff.name) + ' (' + escapeHtml(staff.staff_type) + ')</div>' +
                '<div class="staff-details">Phone: ' + escapeHtml(staff.phone) + ' | Code: ' + escapeHtml(staff.staff_code) + '</div>' +
                '</div>' +
                '<button class="btn btn-danger delete-staff" data-staff-id="' + staff.id + '">Delete</button>' +
                '</div>';
              $container.append(staffHtml);
            });
          } else {
            $container.append('<p class="empty-state">No staff members found for this booth.</p>');
          }
        }).fail(function(){
          $container.html('<p style="color:#dc2626">Error loading staff.</p>');
        });
      }

      function escapeHtml(text) {
        var map = {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#039;'
        };
        return text ? text.replace(/[&<>"']/g, function(m) { return map[m]; }) : '';
      }

      // Handle delete staff
      $(document).on('click', '.delete-staff', function(e){
        e.stopPropagation();
        if (!confirm('Are you sure you want to delete this staff member? This cannot be undone.')) {
          return;
        }
        var staffId = $(this).data('staff-id');
        var $item = $(this).closest('.staff-item');
        var $container = $item.closest('.folder-content');

        $.post('/api/booth/delete-staff/' + staffId + '/', {
          csrfmiddlewaretoken: '{{ csrf_token }}'
        }, function(data){
          if (data.success) {
            $item.fadeOut(300, function(){
              $(this).remove();
              if ($container.find('.staff-item').length === 0) {
                $container.append('<p class="empty-state">No staff members found for this booth.</p>');
              }
            });
          }
        }).fail(function(){
          alert('Error deleting staff.');
        });
      });

      // Initialize breadcrumb
      updateBreadcrumb();
    });
  </script>
</body>
</html>
