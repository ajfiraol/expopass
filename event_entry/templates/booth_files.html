<!DOCTYPE html>
<html>
<head>
  <title>Booth QR Files</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family:Arial;background:#0f172a;color:#fff;padding:24px}
    h1,h2,h3{margin-bottom:8px}
    .meta{font-size:13px;color:#9ca3af;margin-bottom:16px}
    .breadcrumb{margin-bottom:16px;padding:8px;background:#1e293b;border-radius:4px}
    .breadcrumb a{color:#93c5fd;text-decoration:none;margin:0 4px}
    .breadcrumb a:hover{text-decoration:underline}
    .breadcrumb span{color:#64748b}
    .folder-item{cursor:pointer;padding:8px;margin:4px 0;border-radius:4px;background:#1e293b;display:flex;align-items:center;gap:8px;user-select:none}
    .folder-item:hover{background:#334155}
    .folder-item.expanded{background:#334155}
    .folder-icon{font-size:18px;width:24px;text-align:center}
    .folder-content{margin-left:24px;display:none}
    .folder-content.expanded{display:block}
    .staff-item{padding:12px;margin:8px 0;border-radius:6px;background:#020617;border:1px solid #334155;display:flex;align-items:center;gap:16px}
    .staff-info{flex:1}
    .staff-name{font-weight:bold;font-size:16px}
    .staff-details{font-size:13px;color:#9ca3af;margin-top:4px}
    .qr-preview{width:80px;height:80px;border-radius:4px;border:1px solid #334155;object-fit:contain;background:#fff;flex-shrink:0}
    .btn{padding:6px 12px;border-radius:4px;border:none;cursor:pointer;font-size:13px;text-decoration:none;display:inline-block}
    .btn-primary{background:#2563eb;color:#fff}
    .btn-primary:hover{background:#1d4ed8}
    .btn-danger{background:#dc2626;color:#fff}
    .btn-danger:hover{background:#b91c1c}
    a.button{display:inline-block;margin-bottom:16px;padding:6px 10px;border-radius:4px;background:#2563eb;color:#fff;text-decoration:none}
    a.button:hover{background:#1d4ed8}
    .loading{color:#64748b;font-style:italic;padding:16px}
    .empty-state{color:#64748b;padding:16px;text-align:center}
    .modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.9); overflow-y:auto; }
    .modal-content { background:#1e293b; margin:2% auto; padding:20px; border-radius:8px; max-width:95%; width:100%; max-width:500px; color:#fff; }
    .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
    .close { color:#fff; font-size:32px; font-weight:bold; cursor:pointer; padding:0 8px; line-height:1; touch-action:manipulation; }
    .close:hover { color:#9ca3af; }
    #booth-camera-preview { width:100%; margin:0 auto; }
    #booth-camera-preview video { width:100%; max-width:100%; border-radius:4px; display:block; }
    #booth-captured-photo { width:100%; margin:0 auto; }
    #booth-captured-photo img { width:100%; max-width:100%; border-radius:4px; display:block; }
    .camera-controls { margin-top:16px; display:flex; flex-wrap:wrap; gap:8px; justify-content:center; }
    .camera-controls button { padding:12px 24px; margin:4px; border-radius:6px; border:none; cursor:pointer; background:#2563eb; color:#fff; font-size:16px; min-height:44px; touch-action:manipulation; flex:1; min-width:120px; }
    .camera-controls button:active { transform:scale(0.95); }
    .camera-controls button:hover { background:#1d4ed8; }
    .camera-controls .btn-success { background:#16a34a; }
    .camera-controls .btn-success:hover { background:#15803d; }
    .camera-controls .btn-danger { background:#dc2626; }
    .camera-controls .btn-danger:hover { background:#b91c1c; }
    @media (max-width: 600px) {
      .modal-content { margin:1% auto; padding:16px; }
      .camera-controls button { font-size:14px; padding:10px 16px; }
    }
  </style>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
  <h1>Booth QR Files Browser</h1>
  <div class="breadcrumb" id="breadcrumb">
    <a href="/dashboard/">Dashboard</a> <span>/</span> <span id="current-path">Root</span>
  </div>
  <p><a href="/dashboard/" class="button">Back to Dashboard</a></p>

  <div style="margin-bottom:16px;">
    <label>Search (location / booth / staff):
      <input id="booth-search" type="text" placeholder="Type to filter..." style="width:260px;padding:4px;border-radius:4px;border:1px solid #334155;background:#0f172a;color:#fff;">
    </label>
    <span class="meta">Filters visible locations, booths, and loaded staff.</span>
    <div style="margin-top:8px;">
      <label>Booth sort:
        <select id="booth-sort" style="padding:4px;border-radius:4px;border:1px solid #334155;background:#0f172a;color:#fff;">
          <option value="name_asc">Name A‚ÜíZ</option>
          <option value="name_desc">Name Z‚ÜíA</option>
          <option value="count_asc">Staff count ‚Üë</option>
          <option value="count_desc">Staff count ‚Üì</option>
        </select>
      </label>
      <label style="margin-left:12px;">Printed:
        <select id="booth-filter-printed" style="padding:4px;border-radius:4px;border:1px solid #334155;background:#0f172a;color:#fff;">
          <option value="all">All</option>
          <option value="some_printed">Has printed</option>
          <option value="none_printed">No printed</option>
        </select>
      </label>
      <label style="margin-left:12px;">Sold:
        <select id="booth-filter-sold" style="padding:4px;border-radius:4px;border:1px solid #334155;background:#0f172a;color:#fff;">
          <option value="all">All</option>
          <option value="some_sold">Has sold</option>
          <option value="none_sold">No sold</option>
        </select>
      </label>
    </div>
  </div>

  <div id="content">
    {% if locations %}
      {% for loc in locations %}
        <div class="folder-item" data-type="location" data-code="{{ loc.code }}" data-name="{{ loc.name }}">
          <span class="folder-icon">üìÅ</span>
          <span><strong>{{ loc.name }}</strong> ({{ loc.booths|length }} booths)</span>
        </div>
        <div class="folder-content" data-parent-location="{{ loc.code }}">
          {% for booth in loc.booths %}
            <div class="folder-item"
                 data-type="booth"
                 data-location="{{ loc.code }}"
                 data-booth="{{ booth.name }}"
                 data-staff-count="{{ booth.staff_count }}"
                 data-printed-count="{{ booth.printed_count }}"
                 data-sold-count="{{ booth.sold_count }}">
              <span class="folder-icon">üìÇ</span>
              <span><strong>{{ booth.name }}</strong> ({{ booth.staff_count }} staff)</span>
            </div>
            <div class="folder-content" data-location="{{ loc.code }}" data-booth="{{ booth.name }}">
              <div class="loading">Click to load staff...</div>
            </div>
          {% endfor %}
        </div>
      {% endfor %}
    {% else %}
      <p class="empty-state">No locations/booths found. Add staff through the dashboard first.</p>
    {% endif %}
  </div>

  <script>
    $(document).ready(function(){
      var currentPath = ['Root'];

      function updateBreadcrumb() {
        var html = '<a href="/dashboard/">Dashboard</a> <span>/</span>';
        for (var i = 0; i < currentPath.length; i++) {
          if (i === currentPath.length - 1) {
            html += ' <span>' + currentPath[i] + '</span>';
          } else {
            html += ' <a href="#" data-level="' + i + '">' + currentPath[i] + '</a> <span>/</span>';
          }
        }
        $('#breadcrumb').html(html);
      }

      function navigateToLevel(level) {
        currentPath = currentPath.slice(0, level + 1);
        updateBreadcrumb();
        showContent();
      }

      function showContent() {
        // Hide all folder contents first
        $('.folder-content').removeClass('expanded').hide();
        $('.folder-item').removeClass('expanded');

        if (currentPath.length === 1) {
          // Root: show all locations
          $('.folder-item[data-type="location"]').show();
        } else if (currentPath.length === 2) {
          // Location: show booths for that location
          var locCode = currentPath[1];
          $('.folder-item[data-type="location"]').hide();
          $('.folder-item[data-type="location"][data-code="' + locCode + '"]').show().addClass('expanded');
          $('.folder-content[data-parent-location="' + locCode + '"]').show().addClass('expanded');
          $('.folder-item[data-type="booth"][data-location="' + locCode + '"]').show();
        } else if (currentPath.length === 3) {
          // Booth: show staff
          var locCode = currentPath[1];
          var boothName = currentPath[2];
          $('.folder-item').hide();
          $('.folder-item[data-type="location"][data-code="' + locCode + '"]').show().addClass('expanded');
          $('.folder-content[data-parent-location="' + locCode + '"]').show().addClass('expanded');
          $('.folder-item[data-type="booth"][data-location="' + locCode + '"][data-booth="' + boothName + '"]').show().addClass('expanded');
          $('.folder-content[data-location="' + locCode + '"][data-booth="' + boothName + '"]').show().addClass('expanded');
          loadBoothStaff(locCode, boothName);
        }
      }

      // Breadcrumb navigation
      $(document).on('click', '#breadcrumb a[data-level]', function(e){
        e.preventDefault();
        var level = parseInt($(this).data('level'));
        navigateToLevel(level);
      });

      // Location click: expand/collapse booths
      $(document).on('click', '.folder-item[data-type="location"]', function(e){
        e.stopPropagation();
        var $item = $(this);
        var locCode = $item.data('code');
        var locName = $item.data('name');
        var $content = $item.next('.folder-content[data-parent-location="' + locCode + '"]');
        var isExpanded = $item.hasClass('expanded');

        if (isExpanded) {
          $item.removeClass('expanded');
          $content.removeClass('expanded').hide();
          currentPath = ['Root'];
        } else {
          $item.addClass('expanded');
          $content.addClass('expanded').show();
          currentPath = ['Root', locName];
        }
        updateBreadcrumb();
      });

      // Booth click: load and show staff
      $(document).on('click', '.folder-item[data-type="booth"]', function(e){
        e.stopPropagation();
        var location = $(this).data('location');
        var booth = $(this).data('booth');
        var locName = $('.folder-item[data-type="location"][data-code="' + location + '"]').data('name');
        var $content = $(this).next('.folder-content[data-location="' + location + '"][data-booth="' + booth + '"]');
        var isExpanded = $(this).hasClass('expanded');

        if (isExpanded) {
          $(this).removeClass('expanded');
          $content.removeClass('expanded').hide();
          currentPath = ['Root', locName];
        } else {
          $(this).addClass('expanded');
          $content.addClass('expanded').show();
          currentPath = ['Root', locName, booth];
          loadBoothStaff(location, booth);
        }
        updateBreadcrumb();
      });

      function loadBoothStaff(location, boothId) {
        var $container = $('.folder-content[data-location="' + location + '"][data-booth="' + boothId + '"]');
        
        // Don't reload if already loaded
        if ($container.find('.staff-item').length > 0) {
          return;
        }

        $container.html('<div class="loading">Loading staff...</div>');

        $.get('/api/booth/' + encodeURIComponent(location) + '/' + encodeURIComponent(boothId) + '/staff/', function(data){
          $container.html('');

          // Add filter controls for printed / sold
          var filtersHtml = '' +
            '<div class="meta staff-filters" style="margin-bottom:8px;">' +
            'Show: ' +
            '<label>Printed ' +
            '<select class="staff-filter-printed" style="padding:2px 4px;border-radius:4px;border:1px solid #334155;background:#0f172a;color:#fff;margin-right:8px;">' +
            '<option value="all">All</option>' +
            '<option value="printed">Printed</option>' +
            '<option value="not_printed">Not printed</option>' +
            '</select></label>' +
            '<label>Sold ' +
            '<select class="staff-filter-sold" style="padding:2px 4px;border-radius:4px;border:1px solid #334155;background:#0f172a;color:#fff;">' +
            '<option value="all">All</option>' +
            '<option value="sold">Sold</option>' +
            '<option value="not_sold">Not sold</option>' +
            '</select></label>' +
            '</div>';
          $container.append(filtersHtml);

          // Show staff list (already sorted ascending by name from backend)
          if (data.staff && data.staff.length > 0) {
            data.staff.forEach(function(staff){
              var photoUrl = staff.photo_url;
              var imgHtml = '';
              var noPhotoMsg = '';

              if (photoUrl) {
                imgHtml = '<img src="' + photoUrl + '" class="qr-preview" alt="Photo">';
              } else {
                noPhotoMsg = '<div class="staff-details" style="color:#f97316;margin-top:4px;">No photo yet ‚Äì click \"Add Photo\".</div>';
              }

              var staffHtml = '<div class="staff-item" data-staff-id="' + staff.id + '" data-printed="' + (staff.printed ? '1' : '0') + '" data-sold="' + (staff.sold ? '1' : '0') + '">' +
                imgHtml +
                '<div class="staff-info">' +
                '<div class="staff-name">' + escapeHtml(staff.name) + ' (' + escapeHtml(staff.staff_type) + ')</div>' +
                '<div class="staff-details">Phone: ' + escapeHtml(staff.phone) + ' | Code: ' + escapeHtml(staff.staff_code) +
                ' | Printed: ' + (staff.printed ? 'Yes' : 'No') +
                ' | Sold: ' + (staff.sold ? 'Yes' : 'No') +
                '</div>' +
                noPhotoMsg +
                '</div>' +
                '<div style="display:flex;flex-direction:column;gap:8px;">' +
                '<button class="btn btn-primary booth-camera-btn" data-staff-id="' + staff.id + '">üì∑ Add Photo</button>' +
                '<button class="btn btn-danger delete-staff" data-staff-id="' + staff.id + '">Delete</button>' +
                '</div>' +
                '</div>';
              $container.append(staffHtml);
            });
          } else {
            $container.append('<p class="empty-state">No staff members found for this booth.</p>');
          }
        }).fail(function(){
          $container.html('<p style="color:#dc2626">Error loading staff.</p>');
        });
      }

      function escapeHtml(text) {
        var map = {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#039;'
        };
        return text ? text.replace(/[&<>"']/g, function(m) { return map[m]; }) : '';
      }

      // Handle delete staff
      $(document).on('click', '.delete-staff', function(e){
        e.stopPropagation();
        if (!confirm('Are you sure you want to delete this staff member? This cannot be undone.')) {
          return;
        }
        var staffId = $(this).data('staff-id');
        var $item = $(this).closest('.staff-item');
        var $container = $item.closest('.folder-content');

        $.post('/api/booth/delete-staff/' + staffId + '/', {
          csrfmiddlewaretoken: '{{ csrf_token }}'
        }, function(data){
          if (data.success) {
            $item.fadeOut(300, function(){
              $(this).remove();
              if ($container.find('.staff-item').length === 0) {
                $container.append('<p class="empty-state">No staff members found for this booth.</p>');
              }
            });
          }
        }).fail(function(){
          alert('Error deleting staff.');
        });
      });

      // Initialize breadcrumb
      updateBreadcrumb();

      // Global search filtering
      $('#booth-search').on('keyup', function(){
        var q = $(this).val().toLowerCase();

        // Filter locations + booths text
        $('.folder-item[data-type="location"], .folder-item[data-type="booth"]').each(function(){
          var txt = $(this).text().toLowerCase();
          if (!q || txt.indexOf(q) !== -1) {
            $(this).show();
            var parentAttr = $(this).data('code') || $(this).data('location');
            if (parentAttr) {
              $('.folder-content[data-parent-location="' + parentAttr + '"]').show();
            }
          } else {
            $(this).hide();
          }
        });

        // Filter loaded staff items
        $('.staff-item').each(function(){
          var txt = $(this).text().toLowerCase();
          if (!q || txt.indexOf(q) !== -1) {
            $(this).show();
          } else {
            $(this).hide();
          }
        });
      });

      // Booth sorting per location
      $('#booth-sort').on('change', function(){
        var mode = $(this).val();
        $('[data-parent-location]').each(function(){
          var $container = $(this);
          var $booths = $container.find('.folder-item[data-type="booth"]').get();

          $booths.sort(function(a, b){
            var $a = $(a), $b = $(b);
            var nameA = ($a.data('booth') || '').toString().toLowerCase();
            var nameB = ($b.data('booth') || '').toString().toLowerCase();
            var countA = parseInt($a.data('staff-count') || 0, 10);
            var countB = parseInt($b.data('staff-count') || 0, 10);

            if (mode === 'name_asc') return nameA.localeCompare(nameB);
            if (mode === 'name_desc') return nameB.localeCompare(nameA);
            if (mode === 'count_asc') return countA - countB;
            if (mode === 'count_desc') return countB - countA;
            return 0;
          });

          // Re-append booths and their associated staff containers
          $.each($booths, function(_, boothEl){
            var loc = $(boothEl).data('location');
            var booth = $(boothEl).data('booth');
            var $staffContainer = $container
              .parent()
              .find('.folder-content[data-location="' + loc + '"][data-booth="' + booth + '"]');
            $container.append(boothEl);
            $container.append($staffContainer);
          });
        });

        // After sorting, re-apply global booth filters
        applyBoothStatusFilters();
      });

      // Global booth filters for printed / sold (applied when locations/booths are visible)
      function applyBoothStatusFilters() {
        var printedMode = $('#booth-filter-printed').val();
        var soldMode = $('#booth-filter-sold').val();

        $('.folder-item[data-type="booth"]').each(function(){
          var $b = $(this);
          var printedCount = parseInt($b.data('printed-count') || 0, 10);
          var soldCount = parseInt($b.data('sold-count') || 0, 10);

          var matchPrinted = (printedMode === 'all') ||
                             (printedMode === 'some_printed' && printedCount > 0) ||
                             (printedMode === 'none_printed' && printedCount === 0);

          var matchSold = (soldMode === 'all') ||
                          (soldMode === 'some_sold' && soldCount > 0) ||
                          (soldMode === 'none_sold' && soldCount === 0);

          if (matchPrinted && matchSold) {
            $b.show();
          } else {
            $b.hide();
          }
        });
      }

      $('#booth-filter-printed, #booth-filter-sold').on('change', function(){
        applyBoothStatusFilters();
      });

      // Per-booth printed / sold filters
      $(document).on('change', '.staff-filter-printed, .staff-filter-sold', function(){
        var $filters = $(this).closest('.staff-filters');
        var $container = $filters.closest('.folder-content');
        var printedVal = $filters.find('.staff-filter-printed').val();
        var soldVal = $filters.find('.staff-filter-sold').val();

        $container.find('.staff-item').each(function(){
          var $item = $(this);
          var isPrinted = $item.data('printed') == 1;
          var isSold = $item.data('sold') == 1;

          var matchPrinted = (printedVal === 'all') ||
                             (printedVal === 'printed' && isPrinted) ||
                             (printedVal === 'not_printed' && !isPrinted);

          var matchSold = (soldVal === 'all') ||
                          (soldVal === 'sold' && isSold) ||
                          (soldVal === 'not_sold' && !isSold);

          if (matchPrinted && matchSold) {
            $item.show();
          } else {
            $item.hide();
          }
        });
      });
    });

    // Camera capture modal for booth files
    let boothCurrentStaffId = null;
    let boothCameraStream = null;
    let boothCapturedPhotoData = null;

    $(document).on('click', '.booth-camera-btn', function(){
      boothCurrentStaffId = $(this).data('staff-id');
      $('#booth-photo-modal').show();
      initBoothCameraModal();
    });

    $('.booth-close').on('click', function(){
      $('#booth-photo-modal').hide();
      stopBoothCamera();
      boothCapturedPhotoData = null;
    });

    function initBoothCameraModal() {
      // Reset UI state
      $('#booth-captured-photo').hide();
      $('#booth-retake-photo-btn').hide();
      $('#booth-upload-photo-btn').hide();
      $('#booth-upload-status').hide();
      $('#booth-capture-photo-btn').show().prop('disabled', false);
      
      // Use back camera (environment) for better photo quality
      navigator.mediaDevices.getUserMedia({ 
        video: { 
          facingMode: 'environment',  // Back camera
          width: { ideal: 1280 },
          height: { ideal: 720 }
        } 
      })
        .then(function(stream) {
          boothCameraStream = stream;
          const video = document.getElementById('booth-camera-video');
          if (!video) {
            console.error('Video element not found');
            return;
          }
          video.srcObject = stream;
          video.setAttribute('playsinline', '');
          video.setAttribute('webkit-playsinline', '');
          
          // Wait for video to be ready before showing controls
          video.onloadedmetadata = function() {
            console.log('Booth video metadata loaded, dimensions:', video.videoWidth, 'x', video.videoHeight);
            $('#booth-camera-preview').show();
            $('#booth-camera-controls').show();
            $('#booth-capture-photo-btn').prop('disabled', false).show();
          };
          
          video.onerror = function(err) {
            console.error('Video error:', err);
            alert('Error loading camera video.');
          };
        })
        .catch(function(err) {
          console.error('Camera error:', err);
          // Fallback to any available camera if back camera fails
          navigator.mediaDevices.getUserMedia({ video: true })
            .then(function(stream) {
              boothCameraStream = stream;
              const video = document.getElementById('booth-camera-video');
              if (!video) {
                console.error('Video element not found');
                return;
              }
              video.srcObject = stream;
              video.setAttribute('playsinline', '');
              video.setAttribute('webkit-playsinline', '');
              
              video.onloadedmetadata = function() {
                console.log('Booth video metadata loaded (fallback), dimensions:', video.videoWidth, 'x', video.videoHeight);
                $('#booth-camera-preview').show();
                $('#booth-camera-controls').show();
                $('#booth-capture-photo-btn').prop('disabled', false).show();
              };
            })
            .catch(function(fallbackErr) {
              console.error('Fallback camera error:', fallbackErr);
              alert('Could not access camera. Please allow camera permissions and try again.');
            });
        });
    }

    function stopBoothCamera() {
      if (boothCameraStream) {
        boothCameraStream.getTracks().forEach(track => track.stop());
        boothCameraStream = null;
      }
    }

    // Use event delegation for buttons that might be dynamically shown/hidden
    $(document).on('click', '#booth-capture-photo-btn', function(e){
      e.preventDefault();
      console.log('Booth capture button clicked');
      const video = document.getElementById('booth-camera-video');
      
      if (!video) {
        alert('Camera video element not found.');
        return;
      }
      
      // Check if video has valid dimensions (more lenient check)
      if (!video.videoWidth || !video.videoHeight || video.videoWidth === 0 || video.videoHeight === 0) {
        console.log('Booth video not ready. Dimensions:', video.videoWidth, 'x', video.videoHeight, 'ReadyState:', video.readyState);
        alert('Camera is not ready yet. Please wait a moment for the camera to initialize.');
        return;
      }
      
      console.log('Capturing booth photo with dimensions:', video.videoWidth, 'x', video.videoHeight);
      
      try {
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0);
        
        boothCapturedPhotoData = canvas.toDataURL('image/jpeg', 0.8);
        
        if (!boothCapturedPhotoData || boothCapturedPhotoData.length < 100) {
          console.error('Invalid captured data length:', boothCapturedPhotoData ? boothCapturedPhotoData.length : 0);
          alert('Failed to capture photo. Please try again.');
          return;
        }
        
        console.log('Booth photo captured successfully, data length:', boothCapturedPhotoData.length);
        
        $('#booth-photo-preview').attr('src', boothCapturedPhotoData);
        $('#booth-camera-preview').hide();
        $('#booth-captured-photo').show();
        $('#booth-capture-photo-btn').hide();
        $('#booth-retake-photo-btn').show();
        $('#booth-upload-photo-btn').show();
        stopBoothCamera();
      } catch (error) {
        console.error('Capture error:', error);
        alert('Error capturing photo: ' + error.message);
      }
    });

    $(document).on('click', '#booth-retake-photo-btn', function(e){
      e.preventDefault();
      boothCapturedPhotoData = null;
      $('#booth-captured-photo').hide();
      $('#booth-retake-photo-btn').hide();
      $('#booth-upload-photo-btn').hide();
      $('#booth-upload-status').hide();
      initBoothCameraModal();
    });

    $(document).on('click', '#booth-upload-photo-btn', function(e){
      e.preventDefault();
      if (!boothCapturedPhotoData || !boothCurrentStaffId) {
        alert('Please capture a photo first');
        return;
      }

      // Disable button during upload
      var $btn = $(this);
      var $status = $('#booth-upload-status');
      $btn.prop('disabled', true).text('Uploading...');
      $status.show().text('Uploading photo...').css('background', '#2563eb');

      $.ajax({
        url: '/api/staff/' + boothCurrentStaffId + '/upload-photo/',
        method: 'POST',
        data: {
          'csrfmiddlewaretoken': '{{ csrf_token }}',
          'photo_data': boothCapturedPhotoData
        },
        success: function(data){
          if (data.success) {
            $status.text('‚úÖ Photo uploaded successfully!').css('background', '#16a34a');
            setTimeout(function(){
              $('#booth-photo-modal').hide();
              stopBoothCamera();
              // Reload the current booth staff
              var $container = $('.booth-camera-btn[data-staff-id="' + boothCurrentStaffId + '"]').closest('.folder-content');
              var location = $container.data('location');
              var booth = $container.data('booth');
              if (location && booth) {
                loadBoothStaff(location, booth);
              }
            }, 1000);
          } else {
            $status.text('‚ùå Error: ' + (data.error || 'Unknown error')).css('background', '#dc2626');
            $btn.prop('disabled', false).text('‚úÖ Upload Photo');
          }
        },
        error: function(xhr, status, error){
          console.error('Upload error:', xhr.responseText);
          var errorMsg = 'Error uploading photo';
          try {
            var response = JSON.parse(xhr.responseText);
            if (response.error) {
              errorMsg = response.error;
            }
          } catch(e) {
            errorMsg = 'Network error. Please check your connection and try again.';
          }
          $status.text('‚ùå ' + errorMsg).css('background', '#dc2626');
          $btn.prop('disabled', false).text('‚úÖ Upload Photo');
        }
      });
    });
  </script>

  <!-- Photo Upload Modal for Booth Files -->
  <div id="booth-photo-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Add Staff Photo</h2>
        <span class="close booth-close">&times;</span>
      </div>
      <div id="booth-camera-preview" style="display:none;">
        <video id="booth-camera-video" autoplay playsinline></video>
      </div>
      <div id="booth-captured-photo" style="display:none;">
        <img id="booth-photo-preview" alt="Captured photo">
      </div>
      <div class="camera-controls" id="booth-camera-controls" style="display:none;">
        <button id="booth-capture-photo-btn" class="btn-success" style="display:block;">üì∑ Capture Photo</button>
        <button id="booth-retake-photo-btn" style="display:none;">üîÑ Retake</button>
        <button id="booth-upload-photo-btn" style="display:none;">‚úÖ Upload Photo</button>
      </div>
      <div id="booth-upload-status" style="display:none; margin-top:12px; padding:8px; border-radius:4px; background:#1e293b; color:#fff; text-align:center;"></div>
    </div>
  </div>
</body>
</html>
