<!DOCTYPE html>
<html>
<head>
  <title>Event Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {font-family:Arial;background:#0f172a;color:#fff;padding:24px}
    h1,h2{margin-bottom:12px}
    table {width:100%;border-collapse:collapse;margin-top:12px}
    th,td {padding:8px 12px;border-bottom:1px solid #334155;text-align:left}
    th {background:#334155}
    tr:last-child td {border-bottom:none}
    input[type=checkbox]{width:18px;height:18px}
    .filter {margin-bottom:24px}
    a.button {color:#fff;text-decoration:none;background:#2563eb;padding:4px 8px;border-radius:4px}
    .printed-row {background-color:#065f46 !important;} /* green highlight for printed */
  </style>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    .btn-camera:hover { background:#1d4ed8 !important; }
    .modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.9); overflow-y:auto; }
    .modal-content { background:#1e293b; margin:2% auto; padding:20px; border-radius:8px; max-width:95%; width:100%; max-width:500px; color:#fff; }
    .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
    .close { color:#fff; font-size:32px; font-weight:bold; cursor:pointer; padding:0 8px; line-height:1; touch-action:manipulation; }
    .close:hover { color:#9ca3af; }
    #camera-preview { width:100%; margin:0 auto; }
    #camera-preview video { width:100%; max-width:100%; border-radius:4px; display:block; }
    #captured-photo { width:100%; margin:0 auto; }
    #captured-photo img { width:100%; max-width:100%; border-radius:4px; display:block; }
    .camera-controls { margin-top:16px; display:flex; flex-wrap:wrap; gap:8px; justify-content:center; }
    .camera-controls button { padding:12px 24px; margin:4px; border-radius:6px; border:none; cursor:pointer; background:#2563eb; color:#fff; font-size:16px; min-height:44px; touch-action:manipulation; flex:1; min-width:120px; }
    .camera-controls button:active { transform:scale(0.95); }
    .camera-controls button:hover { background:#1d4ed8; }
    .camera-controls .btn-success { background:#16a34a; }
    .camera-controls .btn-success:hover { background:#15803d; }
    .camera-controls .btn-danger { background:#dc2626; }
    .camera-controls .btn-danger:hover { background:#b91c1c; }
    @media (max-width: 600px) {
      .modal-content { margin:1% auto; padding:16px; }
      .camera-controls button { font-size:14px; padding:10px 16px; }
    }
  </style>
</head>
<body>
  <h1>Event Admin Dashboard</h1>

  <p>
    <a href="{% url 'booth_files' %}" class="button">View Booth QR Folders</a>
  </p>

  <div class="filter">
    <form method="get">
      Booth ID: <input type="text" name="booth_id" value="{{ booth_filter }}">
      Location:
      <select name="location">
        <option value="">All</option>
        <option value="1p" {% if location_filter|default:'' == "1p" %}selected{% endif %}>Pavilion 1</option>
        <option value="2p" {% if location_filter|default:'' == "2p" %}selected{% endif %}>Pavilion 2</option>
        <option value="3p" {% if location_filter|default:'' == "3p" %}selected{% endif %}>Pavilion 3</option>
        <option value="4p" {% if location_filter|default:'' == "4p" %}selected{% endif %}>Pavilion 4</option>
        <option value="O" {% if location_filter|default:'' == "O" %}selected{% endif %}>Outdoor</option>
      </select>
      Status:
      <select name="status">
        <option value="all" {% if status_filter == "all" %}selected{% endif %}>All</option>
        <option value="printed" {% if status_filter == "printed" %}selected{% endif %}>Printed</option>
        <option value="not_printed" {% if status_filter == "not_printed" %}selected{% endif %}>Not Printed</option>
      </select>
      Sold:
      <select name="sold">
        <option value="all" {% if sold_filter == "all" %}selected{% endif %}>All</option>
        <option value="sold" {% if sold_filter == "sold" %}selected{% endif %}>Sold</option>
        <option value="not_sold" {% if sold_filter == "not_sold" %}selected{% endif %}>Not Sold</option>
      </select>
      <button type="submit">Filter</button>
    </form>
    <div style="margin-top:12px;">
      <label>Quick search:
        <input type="text" id="quick-search" placeholder="Search name, phone, booth, location, type" style="width:260px;padding:4px;border-radius:4px;border:1px solid #334155;background:#0f172a;color:#fff;">
      </label>
      <span style="font-size:12px;color:#9ca3af;margin-left:8px;">(client-side, on current page)</span>
    </div>
    <p>
      Total: {{ total_count }} |
      Printed: {{ printed_count }} |
      Not Printed: {{ not_printed_count }} |
      Sold: {{ sold_count }} |
      Not Sold: {{ not_sold_count }}
    </p>
  </div>

  <table>
    <tr>
      <th class="sortable" data-sort-key="booth">Booth ID â–²â–¼</th>
      <th class="sortable" data-sort-key="location">Location â–²â–¼</th>
      <th class="sortable" data-sort-key="type">Staff Type â–²â–¼</th>
      <th class="sortable" data-sort-key="name">Name â–²â–¼</th>
      <th class="sortable" data-sort-key="phone">Phone â–²â–¼</th>
      <th>Photo</th>
      <th>QR Code</th>
    </tr>
    {% for s in staff_list %}
    <tr class="{% if s.printed %}printed-row{% endif %}" data-id="{{ s.id }}"
        data-booth="{{ s.booth_id|default:'' }}"
        data-location="{{ s.get_location_display|default:'' }}"
        data-type="{{ s.staff_type|default:'' }}"
        data-name="{{ s.name|default:'' }}"
        data-phone="{{ s.phone_number|default:'' }}"
        data-printed="{{ s.printed|yesno:'1,0' }}"
        data-sold="{{ s.sold|yesno:'1,0' }}">
      <td>{{ s.booth_id }}</td>
      <td>{{ s.get_location_display }}</td>
      <td>{{ s.staff_type }}</td>
      <td>{{ s.name }}</td>
      <td>{{ s.phone_number }}</td>
      <td>
        {% if s.photo %}
          <img src="{{ s.photo.url }}" alt="Photo" style="width:50px;height:50px;object-fit:cover;border-radius:4px;">
        {% else %}
          <span style="color:#9ca3af;">No Photo</span>
        {% endif %}
        <br>
        <button class="btn-camera" data-staff-id="{{ s.id }}" style="margin-top:4px;padding:4px 8px;font-size:11px;background:#2563eb;color:#fff;border:none;border-radius:4px;cursor:pointer;">ðŸ“· Add Photo</button>
      </td>
      <td>
        {% if s.qr_code_image %}
          <a href="{% url 'download_qr' s.id %}" class="button">Download QR</a>
        {% else %}
          No QR
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </table>

  <script>
    $(document).ready(function(){
      // Quick client-side search
      $('#quick-search').on('keyup', function(){
        var q = $(this).val().toLowerCase();
        $('table tr[data-id]').each(function(){
          var $row = $(this);
          var hay = (
            ($row.data('booth') || '') + ' ' +
            ($row.data('location') || '') + ' ' +
            ($row.data('type') || '') + ' ' +
            ($row.data('name') || '') + ' ' +
            ($row.data('phone') || '')
          ).toLowerCase();
          if (!q || hay.indexOf(q) !== -1) {
            $row.show();
          } else {
            $row.hide();
          }
        });
      });

      // Simple client-side sorting
      var currentSort = { key: null, dir: 1 };

      function compare(a, b, key, dir) {
        var va = $(a).data(key) || '';
        var vb = $(b).data(key) || '';
        // numeric if both look like numbers
        var na = parseFloat(va), nb = parseFloat(vb);
        if (!isNaN(na) && !isNaN(nb)) {
          return (na - nb) * dir;
        }
        va = String(va).toLowerCase();
        vb = String(vb).toLowerCase();
        if (va < vb) return -1 * dir;
        if (va > vb) return 1 * dir;
        return 0;
      }

      $('.sortable').on('click', function(){
        var key = $(this).data('sort-key');
        if (!key) return;
        if (currentSort.key === key) {
          currentSort.dir = -currentSort.dir; // toggle
        } else {
          currentSort.key = key;
          currentSort.dir = 1;
        }

        var $rows = $('table tr[data-id]').get();
        $rows.sort(function(a, b){
          return compare(a, b, key, currentSort.dir);
        });
        $.each($rows, function(idx, row){
          $('table').append(row);
        });
      });
    });

    // Camera capture modal
    let currentStaffId = null;
    let cameraStream = null;
    let capturedPhotoData = null;

    $(document).on('click', '.btn-camera', function(){
      currentStaffId = $(this).data('staff-id');
      $('#photo-modal').show();
      initCameraModal();
    });

    $('.close').on('click', function(){
      $('#photo-modal').hide();
      stopCamera();
      capturedPhotoData = null;
    });

    function initCameraModal() {
      // Use back camera (environment) for better photo quality
      navigator.mediaDevices.getUserMedia({ 
        video: { 
          facingMode: 'environment',  // Back camera
          width: { ideal: 1280 },
          height: { ideal: 720 }
        } 
      })
        .then(function(stream) {
          cameraStream = stream;
          const video = document.getElementById('camera-video');
          video.srcObject = stream;
          video.setAttribute('playsinline', '');
          video.setAttribute('webkit-playsinline', '');
          $('#camera-preview').show();
          $('#captured-photo').hide();
          $('#camera-controls').show();
        })
        .catch(function(err) {
          console.error('Camera error:', err);
          // Fallback to any available camera if back camera fails
          navigator.mediaDevices.getUserMedia({ video: true })
            .then(function(stream) {
              cameraStream = stream;
              const video = document.getElementById('camera-video');
              video.srcObject = stream;
              video.setAttribute('playsinline', '');
              video.setAttribute('webkit-playsinline', '');
              $('#camera-preview').show();
              $('#captured-photo').hide();
              $('#camera-controls').show();
            })
            .catch(function(fallbackErr) {
              alert('Could not access camera. Please allow camera permissions.');
            });
        });
    }

    function stopCamera() {
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
      }
    }

    $('#capture-photo-btn').on('click', function(){
      const video = document.getElementById('camera-video');
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0);
      
      capturedPhotoData = canvas.toDataURL('image/jpeg', 0.8);
      $('#photo-preview').attr('src', capturedPhotoData);
      $('#camera-preview').hide();
      $('#captured-photo').show();
      $('#retake-photo-btn').show();
      $('#upload-photo-btn').show();
      stopCamera();
    });

    $('#retake-photo-btn').on('click', function(){
      capturedPhotoData = null;
      $('#captured-photo').hide();
      $('#retake-photo-btn').hide();
      $('#upload-photo-btn').hide();
      initCameraModal();
    });

    $('#upload-photo-btn').on('click', function(){
      if (!capturedPhotoData || !currentStaffId) {
        alert('Please capture a photo first');
        return;
      }

      $.post('/api/staff/' + currentStaffId + '/upload-photo/', {
        'csrfmiddlewaretoken': '{{ csrf_token }}',
        'photo_data': capturedPhotoData
      }, function(data){
        if (data.success) {
          alert('Photo uploaded successfully!');
          location.reload();
        } else {
          alert('Error uploading photo: ' + (data.error || 'Unknown error'));
        }
      }).fail(function(){
        alert('Error uploading photo');
      });
    });
  </script>

  <!-- Photo Upload Modal -->
  <div id="photo-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Add Staff Photo</h2>
        <span class="close">&times;</span>
      </div>
      <div id="camera-preview" style="display:none;">
        <video id="camera-video" autoplay playsinline></video>
      </div>
      <div id="captured-photo" style="display:none;">
        <img id="photo-preview" alt="Captured photo">
      </div>
      <div class="camera-controls" id="camera-controls" style="display:none;">
        <button id="capture-photo-btn" class="btn-success">Capture Photo</button>
        <button id="retake-photo-btn" style="display:none;">Retake</button>
        <button id="upload-photo-btn" style="display:none;">Upload Photo</button>
      </div>
    </div>
  </div>

</body>
</html>
