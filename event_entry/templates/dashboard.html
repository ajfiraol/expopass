<!DOCTYPE html>
<html>
<head>
  <title>Event Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {font-family:Arial;background:#0f172a;color:#fff;padding:24px}
    h1,h2{margin-bottom:12px}
    table {width:100%;border-collapse:collapse;margin-top:12px}
    th,td {padding:8px 12px;border-bottom:1px solid #334155;text-align:left}
    th {background:#334155}
    tr:last-child td {border-bottom:none}
    input[type=checkbox]{width:18px;height:18px}
    .filter {margin-bottom:24px}
    a.button {color:#fff;text-decoration:none;background:#2563eb;padding:4px 8px;border-radius:4px}
    .printed-row {background-color:#065f46 !important;} /* green highlight for printed */
  </style>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    .btn-camera:hover { background:#1d4ed8 !important; }
    /* Prevent body scroll when modal is open */
    body.modal-open { overflow: hidden; position: fixed; width: 100%; }
    
    .modal { 
      display:none; 
      position:fixed; 
      z-index:10000; 
      left:0; 
      top:0; 
      width:100%; 
      height:100%; 
      background:rgba(0,0,0,0.95); 
      overflow-y:auto; 
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
    }
    
    .modal-content { 
      background:#1e293b; 
      margin:0; 
      padding:0; 
      border-radius:0; 
      width:100%; 
      height:100%; 
      max-width:100%; 
      color:#fff; 
      display:flex; 
      flex-direction:column;
      position:relative;
    }
    
    .modal-header { 
      display:flex; 
      justify-content:space-between; 
      align-items:center; 
      padding:16px 20px; 
      background:rgba(0,0,0,0.5);
      position:sticky;
      top:0;
      z-index:10;
      flex-shrink:0;
    }
    
    .modal-header h2 {
      margin:0;
      font-size:18px;
      font-weight:600;
    }
    
    .close { 
      color:#fff; 
      font-size:36px; 
      font-weight:bold; 
      cursor:pointer; 
      padding:8px 12px; 
      line-height:1; 
      touch-action:manipulation; 
      min-width:44px;
      min-height:44px;
      display:flex;
      align-items:center;
      justify-content:center;
      -webkit-tap-highlight-color: transparent;
    }
    
    .close:active { 
      background:rgba(255,255,255,0.1); 
      border-radius:50%;
    }
    
    #camera-preview { 
      width:100%; 
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#000;
      overflow:hidden;
      position:relative;
    }
    
    #camera-preview video { 
      width:100%; 
      height:100%;
      object-fit:cover;
      display:block;
    }
    
    #captured-photo { 
      width:100%; 
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#000;
      overflow:hidden;
    }
    
    #captured-photo img { 
      width:100%; 
      height:100%;
      object-fit:contain;
      display:block;
    }
    
    .camera-controls { 
      padding:20px;
      display:flex; 
      flex-direction:column;
      gap:12px; 
      background:rgba(0,0,0,0.5);
      flex-shrink:0;
    }
    
    .camera-controls button { 
      padding:16px 24px; 
      border-radius:12px; 
      border:none; 
      cursor:pointer; 
      background:#2563eb; 
      color:#fff; 
      font-size:18px; 
      font-weight:600;
      min-height:56px; 
      touch-action:manipulation; 
      width:100%;
      -webkit-tap-highlight-color: transparent;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    
    .camera-controls button:active { 
      transform:scale(0.97); 
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .camera-controls .btn-success { 
      background:#16a34a; 
      font-size:20px;
    }
    
    .camera-controls .btn-success:active { 
      background:#15803d; 
    }
    
    #upload-status {
      margin:0 20px 20px 20px;
      padding:12px;
      border-radius:8px;
      background:#1e293b;
      color:#fff;
      text-align:center;
      font-size:16px;
    }
    
    /* Desktop styles */
    @media (min-width: 768px) {
      .modal-content { 
        margin:5% auto; 
        padding:0;
        border-radius:12px; 
        max-width:600px; 
        height:auto;
        max-height:90vh;
      }
      
      .modal-header {
        border-radius:12px 12px 0 0;
      }
      
      #camera-preview {
        height:400px;
        flex:none;
      }
      
      #captured-photo {
        height:400px;
        flex:none;
      }
      
      .camera-controls {
        flex-direction:row;
        border-radius:0 0 12px 12px;
      }
      
      .camera-controls button {
        flex:1;
        min-width:auto;
      }
    }
    
    /* Landscape phone optimization */
    @media (max-width: 900px) and (orientation: landscape) {
      .modal-header {
        padding:12px 16px;
      }
      
      .modal-header h2 {
        font-size:16px;
      }
      
      #camera-preview {
        height:calc(100vh - 200px);
      }
      
      #captured-photo {
        height:calc(100vh - 200px);
      }
      
      .camera-controls {
        padding:16px;
        flex-direction:row;
      }
      
      .camera-controls button {
        padding:12px 16px;
        font-size:16px;
        min-height:48px;
      }
    }
  </style>
</head>
<body>
  <h1>Event Admin Dashboard</h1>

  <p>
    <a href="{% url 'booth_files' %}" class="button">View Booth QR Folders</a>
  </p>

  <div class="filter">
    <form method="get">
      Booth ID: <input type="text" name="booth_id" value="{{ booth_filter }}">
      Location:
      <select name="location">
        <option value="">All</option>
        <option value="1p" {% if location_filter|default:'' == "1p" %}selected{% endif %}>Pavilion 1</option>
        <option value="2p" {% if location_filter|default:'' == "2p" %}selected{% endif %}>Pavilion 2</option>
        <option value="3p" {% if location_filter|default:'' == "3p" %}selected{% endif %}>Pavilion 3</option>
        <option value="4p" {% if location_filter|default:'' == "4p" %}selected{% endif %}>Pavilion 4</option>
        <option value="O" {% if location_filter|default:'' == "O" %}selected{% endif %}>Outdoor</option>
      </select>
      Status:
      <select name="status">
        <option value="all" {% if status_filter == "all" %}selected{% endif %}>All</option>
        <option value="printed" {% if status_filter == "printed" %}selected{% endif %}>Printed</option>
        <option value="not_printed" {% if status_filter == "not_printed" %}selected{% endif %}>Not Printed</option>
      </select>
      Sold:
      <select name="sold">
        <option value="all" {% if sold_filter == "all" %}selected{% endif %}>All</option>
        <option value="sold" {% if sold_filter == "sold" %}selected{% endif %}>Sold</option>
        <option value="not_sold" {% if sold_filter == "not_sold" %}selected{% endif %}>Not Sold</option>
      </select>
      <button type="submit">Filter</button>
    </form>
    <div style="margin-top:12px;">
      <label>Quick search:
        <input type="text" id="quick-search" placeholder="Search name, phone, booth, location, type" style="width:260px;padding:4px;border-radius:4px;border:1px solid #334155;background:#0f172a;color:#fff;">
      </label>
      <span style="font-size:12px;color:#9ca3af;margin-left:8px;">(client-side, on current page)</span>
    </div>
    <p>
      Total: {{ total_count }} |
      Printed: {{ printed_count }} |
      Not Printed: {{ not_printed_count }} |
      Sold: {{ sold_count }} |
      Not Sold: {{ not_sold_count }}
    </p>
  </div>

  <table>
    <tr>
      <th class="sortable" data-sort-key="booth">Booth ID â–²â–¼</th>
      <th class="sortable" data-sort-key="location">Location â–²â–¼</th>
      <th class="sortable" data-sort-key="type">Staff Type â–²â–¼</th>
      <th class="sortable" data-sort-key="name">Name â–²â–¼</th>
      <th class="sortable" data-sort-key="phone">Phone â–²â–¼</th>
      <th>Photo</th>
      <th>QR Code</th>
    </tr>
    {% for s in staff_list %}
    <tr class="{% if s.printed %}printed-row{% endif %}" data-id="{{ s.id }}"
        data-booth="{{ s.booth_id|default:'' }}"
        data-location="{{ s.get_location_display|default:'' }}"
        data-type="{{ s.staff_type|default:'' }}"
        data-name="{{ s.name|default:'' }}"
        data-phone="{{ s.phone_number|default:'' }}"
        data-printed="{{ s.printed|yesno:'1,0' }}"
        data-sold="{{ s.sold|yesno:'1,0' }}">
      <td>{{ s.booth_id }}</td>
      <td>{{ s.get_location_display }}</td>
      <td>{{ s.staff_type }}</td>
      <td>{{ s.name }}</td>
      <td>{{ s.phone_number }}</td>
      <td>
        {% if s.photo %}
          <img src="{{ s.photo.url }}" alt="Photo" style="width:50px;height:50px;object-fit:cover;border-radius:4px;">
          <br>
          <button class="btn-camera" data-staff-id="{{ s.id }}" data-has-photo="true" style="margin-top:4px;padding:4px 8px;font-size:11px;background:#2563eb;color:#fff;border:none;border-radius:4px;cursor:pointer;">ðŸ”„ Change Photo</button>
        {% else %}
          <span style="color:#9ca3af;">No Photo</span>
          <br>
          <button class="btn-camera" data-staff-id="{{ s.id }}" data-has-photo="false" style="margin-top:4px;padding:4px 8px;font-size:11px;background:#2563eb;color:#fff;border:none;border-radius:4px;cursor:pointer;">ðŸ“· Add Photo</button>
        {% endif %}
      </td>
      <td>
        {% if s.qr_code_image %}
          <a href="{% url 'download_qr' s.id %}" class="button">Download QR</a>
        {% else %}
          No QR
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </table>

  <script>
    $(document).ready(function(){
      // Quick client-side search
      $('#quick-search').on('keyup', function(){
        var q = $(this).val().toLowerCase();
        $('table tr[data-id]').each(function(){
          var $row = $(this);
          var hay = (
            ($row.data('booth') || '') + ' ' +
            ($row.data('location') || '') + ' ' +
            ($row.data('type') || '') + ' ' +
            ($row.data('name') || '') + ' ' +
            ($row.data('phone') || '')
          ).toLowerCase();
          if (!q || hay.indexOf(q) !== -1) {
            $row.show();
          } else {
            $row.hide();
          }
        });
      });

      // Simple client-side sorting
      var currentSort = { key: null, dir: 1 };

      function compare(a, b, key, dir) {
        var va = $(a).data(key) || '';
        var vb = $(b).data(key) || '';
        // numeric if both look like numbers
        var na = parseFloat(va), nb = parseFloat(vb);
        if (!isNaN(na) && !isNaN(nb)) {
          return (na - nb) * dir;
        }
        va = String(va).toLowerCase();
        vb = String(vb).toLowerCase();
        if (va < vb) return -1 * dir;
        if (va > vb) return 1 * dir;
        return 0;
      }

      $('.sortable').on('click', function(){
        var key = $(this).data('sort-key');
        if (!key) return;
        if (currentSort.key === key) {
          currentSort.dir = -currentSort.dir; // toggle
        } else {
          currentSort.key = key;
          currentSort.dir = 1;
        }

        var $rows = $('table tr[data-id]').get();
        $rows.sort(function(a, b){
          return compare(a, b, key, currentSort.dir);
        });
        $.each($rows, function(idx, row){
          $('table').append(row);
        });
      });
    });

    // Camera capture modal
    let currentStaffId = null;
    let cameraStream = null;
    let capturedPhotoData = null;

    $(document).on('click', '.btn-camera', function(){
      currentStaffId = $(this).data('staff-id');
      var hasPhoto = $(this).data('has-photo') === true;
      // Update modal title based on whether photo exists
      if (hasPhoto) {
        $('#photo-modal h2').text('Change Staff Photo');
      } else {
        $('#photo-modal h2').text('Add Staff Photo');
      }
      // Prevent body scroll when modal opens
      $('body').addClass('modal-open');
      $('#photo-modal').show();
      initCameraModal();
    });

    $(document).on('click', '.close', function(){
      $('#photo-modal').hide();
      $('body').removeClass('modal-open');
      stopCamera();
      capturedPhotoData = null;
    });
    
    // Close modal when clicking outside (on mobile)
    $(document).on('click', '.modal', function(e){
      if ($(e.target).hasClass('modal')) {
        $('#photo-modal').hide();
        $('body').removeClass('modal-open');
        stopCamera();
        capturedPhotoData = null;
      }
    });

    function initCameraModal() {
      // Reset UI state
      $('#captured-photo').hide();
      $('#retake-photo-btn').hide();
      $('#upload-photo-btn').hide();
      $('#upload-status').hide();
      $('#capture-photo-btn').show().prop('disabled', false);
      
      // Use back camera (environment) for better photo quality
      navigator.mediaDevices.getUserMedia({ 
        video: { 
          facingMode: 'environment',  // Back camera
          width: { ideal: 1280 },
          height: { ideal: 720 }
        } 
      })
        .then(function(stream) {
          cameraStream = stream;
          const video = document.getElementById('camera-video');
          if (!video) {
            console.error('Video element not found');
            return;
          }
          video.srcObject = stream;
          video.setAttribute('playsinline', '');
          video.setAttribute('webkit-playsinline', '');
          
          // Wait for video to be ready before showing controls
          video.onloadedmetadata = function() {
            console.log('Video metadata loaded, dimensions:', video.videoWidth, 'x', video.videoHeight);
            $('#camera-preview').show();
            $('#camera-controls').show();
            $('#capture-photo-btn').prop('disabled', false).show();
          };
          
          video.onerror = function(err) {
            console.error('Video error:', err);
            alert('Error loading camera video.');
          };
        })
        .catch(function(err) {
          console.error('Camera error:', err);
          // Fallback to any available camera if back camera fails
          navigator.mediaDevices.getUserMedia({ video: true })
            .then(function(stream) {
              cameraStream = stream;
              const video = document.getElementById('camera-video');
              if (!video) {
                console.error('Video element not found');
                return;
              }
              video.srcObject = stream;
              video.setAttribute('playsinline', '');
              video.setAttribute('webkit-playsinline', '');
              
              video.onloadedmetadata = function() {
                console.log('Video metadata loaded (fallback), dimensions:', video.videoWidth, 'x', video.videoHeight);
                $('#camera-preview').show();
                $('#camera-controls').show();
                $('#capture-photo-btn').prop('disabled', false).show();
              };
            })
            .catch(function(fallbackErr) {
              console.error('Fallback camera error:', fallbackErr);
              alert('Could not access camera. Please allow camera permissions and try again.');
            });
        });
    }

    function stopCamera() {
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
      }
    }

    // Use event delegation for buttons that might be dynamically shown/hidden
    $(document).on('click', '#capture-photo-btn', function(e){
      e.preventDefault();
      console.log('Capture button clicked');
      const video = document.getElementById('camera-video');
      
      if (!video) {
        alert('Camera video element not found.');
        return;
      }
      
      // Check if video has valid dimensions (more lenient check)
      if (!video.videoWidth || !video.videoHeight || video.videoWidth === 0 || video.videoHeight === 0) {
        console.log('Video not ready. Dimensions:', video.videoWidth, 'x', video.videoHeight, 'ReadyState:', video.readyState);
        alert('Camera is not ready yet. Please wait a moment for the camera to initialize.');
        return;
      }
      
      console.log('Capturing photo with dimensions:', video.videoWidth, 'x', video.videoHeight);
      
      try {
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0);
        
        capturedPhotoData = canvas.toDataURL('image/jpeg', 0.8);
        
        if (!capturedPhotoData || capturedPhotoData.length < 100) {
          console.error('Invalid captured data length:', capturedPhotoData ? capturedPhotoData.length : 0);
          alert('Failed to capture photo. Please try again.');
          return;
        }
        
        console.log('Photo captured successfully, data length:', capturedPhotoData.length);
        
        $('#photo-preview').attr('src', capturedPhotoData);
        $('#camera-preview').hide();
        $('#captured-photo').show();
        $('#capture-photo-btn').hide();
        $('#retake-photo-btn').show();
        $('#upload-photo-btn').show();
        stopCamera();
      } catch (error) {
        console.error('Capture error:', error);
        alert('Error capturing photo: ' + error.message);
      }
    });

    $(document).on('click', '#retake-photo-btn', function(e){
      e.preventDefault();
      capturedPhotoData = null;
      $('#captured-photo').hide();
      $('#retake-photo-btn').hide();
      $('#upload-photo-btn').hide();
      $('#upload-status').hide();
      initCameraModal();
    });

    $(document).on('click', '#upload-photo-btn', function(e){
      e.preventDefault();
      if (!capturedPhotoData || !currentStaffId) {
        alert('Please capture a photo first');
        return;
      }

      // Disable button during upload
      var $btn = $(this);
      var $status = $('#upload-status');
      $btn.prop('disabled', true).text('Uploading...');
      $status.show().text('Uploading photo...').css('background', '#2563eb');

      $.ajax({
        url: '/api/staff/' + currentStaffId + '/upload-photo/',
        method: 'POST',
        data: {
          'csrfmiddlewaretoken': '{{ csrf_token }}',
          'photo_data': capturedPhotoData
        },
        success: function(data){
          if (data.success) {
            $status.text('âœ… Photo uploaded successfully!').css('background', '#16a34a');
            setTimeout(function(){
              $('#photo-modal').hide();
              stopCamera();
              location.reload();
            }, 1000);
          } else {
            $status.text('âŒ Error: ' + (data.error || 'Unknown error')).css('background', '#dc2626');
            $btn.prop('disabled', false).text('âœ… Upload Photo');
          }
        },
        error: function(xhr, status, error){
          console.error('Upload error:', xhr.responseText);
          var errorMsg = 'Error uploading photo';
          try {
            var response = JSON.parse(xhr.responseText);
            if (response.error) {
              errorMsg = response.error;
            }
          } catch(e) {
            errorMsg = 'Network error. Please check your connection and try again.';
          }
          $status.text('âŒ ' + errorMsg).css('background', '#dc2626');
          $btn.prop('disabled', false).text('âœ… Upload Photo');
        }
      });
    });
  </script>

  <!-- Photo Upload Modal -->
  <div id="photo-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Add Staff Photo</h2>
        <span class="close">&times;</span>
      </div>
      <div id="camera-preview" style="display:none;">
        <video id="camera-video" autoplay playsinline webkit-playsinline x5-playsinline></video>
      </div>
      <div id="captured-photo" style="display:none;">
        <img id="photo-preview" alt="Captured photo">
      </div>
      <div class="camera-controls" id="camera-controls" style="display:none;">
        <button id="capture-photo-btn" class="btn-success" style="display:block;">ðŸ“· Capture Photo</button>
        <button id="retake-photo-btn" style="display:none;">ðŸ”„ Retake</button>
        <button id="upload-photo-btn" style="display:none;">âœ… Upload Photo</button>
      </div>
      <div id="upload-status" style="display:none; margin-top:12px; padding:8px; border-radius:4px; background:#1e293b; color:#fff; text-align:center;"></div>
    </div>
  </div>

</body>
</html>
